#!/bin/bash
# Pre-push hook: Run lint/tests and validate version tags

set -e

echo "Running pre-push checks..."

# Run linting
echo "→ Running ruff check..."
uv run ruff check src/ tests/

echo "→ Running ruff format check..."
uv run ruff format --check src/ tests/

echo "→ Running mypy..."
uv run mypy src/potluck/

# Run tests
echo "→ Running tests..."
uv run pytest tests/ -q

echo "✓ All checks passed!"
echo ""

# Validate version tags
while read local_ref local_sha remote_ref remote_sha; do
    # Check if pushing a tag
    if [[ "$local_ref" =~ ^refs/tags/v ]]; then
        tag_name="${local_ref#refs/tags/}"

        # Validate semantic version format: vMAJOR.MINOR.PATCH
        if ! [[ "$tag_name" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Tag '$tag_name' does not follow semantic versioning (vX.Y.Z)"
            exit 1
        fi

        # Extract version from tag
        version="${tag_name#v}"

        # Check if pyproject.toml version matches
        pyproject_version=$(grep -Po '(?<=^version = ")[^"]+' pyproject.toml)
        if [ "$version" != "$pyproject_version" ]; then
            echo "ERROR: Tag version ($version) does not match pyproject.toml version ($pyproject_version)"
            echo "Update pyproject.toml before tagging."
            exit 1
        fi

        echo "Version tag $tag_name validated successfully"
    fi
done

exit 0
